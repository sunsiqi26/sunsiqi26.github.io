---
title: "bytecode"
date: 2022-05-26T20:04:02+08:00
draft: false
---
Please display me

## V8 bytecode

### 环境
win10 + vs2017  
下载链接：https://my.visualstudio.com/Downloads?q=visual%20studio%202017&wt.mc_id=o~msft~vscom~older-downloads  
企业版：NJVYC-BMHX2-G77MM-4XJMR-6Q8QF   
专业版：KBJFW-NXHK6-W4WJM-CRMQB-G3CDH
```
git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
fetch v8
git checkout -b 7.3 -t branch-heads/7.3

set DEPOT_TOOLS_WIN_TOOLCHAIN=0
set GYP_MSVS_OVERRIDE_PATH=F:\Microsoft Visual Studio\2017
set WINDOWSSDKDIR=D:\Windows Kits\10

gclient sync
python3 tools\dev\v8gen.py x64.debug 
```

### 指令
- StackCheck：固定出现，检查stack有没有overflow 
- Ld*属于加载到累加器的指令集
- Star寄存器操作指令
- src/interpreter/interpreter-generator.cc

### 功能
1. 变量赋值，寄存器变化，抛出错误
2. 判断式，对于 if (true) 这种case，V8 Ignition 会做优化。在程式码中同一个字串是可以被重复利用的，都是指向同一个constant pool 的元素
3. loop，
4. 函数

### 生成
通过遍历AST树结构生成，具体实现是switch case配合预设的宏定义模板。AST树的所有节点都继承自AstNode类，AstNode的NodeType将父类转成具体的子类，之后才能进行数据读取，生成字节码。V8中AST到字节码的翻译过程，与编译LLVM中AST到三地址码的翻译相似。
1. AstNode --> Assignment  
```
void BytecodeGenerator::VisitAssignment(Assignment* expr) {
  AssignmentLhsData lhs_data = PrepareAssignmentLhs(expr->target());

  VisitForAccumulatorValue(expr->value());

  builder()->SetExpressionPosition(expr);
  BuildAssignment(lhs_data, expr->op(), expr->lookup_hoisting_mode());
}
```
2. Bytecode入口BytecodeGenerator::GenerateBytecodeBody() --> 进入VisitStatements(literal->body())生成字节码

https://www.zhihu.com/people/v8blink/posts?page=4

编译涉及到的概念包括：词法分析，用来生成token字；语法分析(parse)，最后生成抽象语法树（AST）。


### bytecode序列能否应用于为静态分析兜底分析代码意图

- 操作码n-gram？当前操作码出现的概率只与前n个有关
- Android字节码转化的目的是减少代码本身的语义信息、增加其安全性并减少混淆带来的性能消耗。
- 由于JavaScript是动态类型、面向原型的语言，对象和变量的美型可能随时发生变化，所以只有在运行阶段才可以真正确定变量和对象的类型，因此在编译阶段对热点函数代码进行优化时需要进行类型特化(ype specifitatin,即假定热点函数中变量是某种类型，但这是不可靠的，所以在运行机器码之前需要进行检查，即deoptimizaton check,确保变量的类型和JT编译时假定类型一样，如果deoptirmzation check失败，表示热点函数中数据类型发生了变化，需要进行脱优化(deoptimization)处理，即转到相应的字节码处重新执行。
- 我们是第一个应用字节码来表示漏洞特征，并采用基于图的静态分析方法来提取字节码片
  - https://link.springer.com/chapter/10.1007/978-3-030-41579-2_12
- 基于恶意软件行为序列(API调用序列)的动态分析



1. base64、16进制类似编码，constant pool有明文
```
const { exec } = require("child_process")
exec('calc.exe')

eval(Buffer.from('Y29uc3QgeyBleGVjIH0gPSByZXF1aXJlKCJjaGlsZF9wcm9jZXNzIikKZXhlYygnY2FsYy5leGUnKQ==', 'base64').toString())
```

```
[generated bytecode for function:  (0x01a165689651 <SharedFunctionInfo>)]
Parameter count 1
Register count 4
Frame size 32
    0 E> 000001A16568975E @    0 : 85 00 01          CreateEvalContext [0], [1]
         000001A165689761 @    3 : 16 fa             PushContext r1
         000001A165689763 @    5 : 0f                LdaTheHole 
         000001A165689764 @    6 : 1d 02             StaCurrentContextSlot [2]
   17 S> 000001A165689766 @    8 : 18 fa 06 00       LdaContextSlot r1, [6], [0]
         000001A16568976A @   12 : 26 f9             Star r2
         000001A16568976C @   14 : 12 01             LdaConstant [1]
         000001A16568976E @   16 : 26 f8             Star r3
   17 E> 000001A165689770 @   18 : 5d f9 f8 00       CallUndefinedReceiver1 r2, r3, [0]
         000001A165689774 @   22 : 26 f9             Star r2
    8 S> 000001A165689776 @   24 : 28 f9 02 02       LdaNamedProperty r2, [2], [2]
         000001A16568977A @   28 : 1d 02             StaCurrentContextSlot [2]
   42 S> 000001A16568977C @   30 : 1b 02             LdaImmutableCurrentContextSlot [2]
         000001A16568977E @   32 : 26 f9             Star r2
         000001A165689780 @   34 : 12 03             LdaConstant [3]
         000001A165689782 @   36 : 26 f8             Star r3
   42 E> 000001A165689784 @   38 : 5d f9 f8 04       CallUndefinedReceiver1 r2, r3, [4]
         000001A165689788 @   42 : 26 fb             Star r0
   58 S> 000001A16568978A @   44 : aa                Return 
Constant pool (size = 4)
000001A1656896F9: [FixedArray] in OldSpace
 - map: 0x01a859fc0729 <Map>
 - length: 4
           0: 0x01a165689689 <ScopeInfo EVAL_SCOPE [10]>
           1: 0x006767481669 <String[#13]: child_process>
           2: 0x01a859fc3521 <String[#4]: exec>
           3: 0x01a165689621 <String[#8]: calc.exe>
Handler Table (size = 0)
Source Position Table (size = 17)
0x01a165689791 <ByteArray[17]>
```
1. 逻辑结构混淆：hoisting机制自动会解决一些
2. 标识符混淆
3. 不同函数声明的字节码可能是相同的-->字节码相似性
4. 查看隐藏类：/d8 --allow-natives-syntax ./test.js
5. 

### 字节码逻辑梳理

### 检测方法

- 恶意npm包字节码
- 处理：filter、切片？
- package.json中的命令
- hoisting机制好像会把一些变量、函数等声明提前，字节码的顺序可能更合逻辑
- turbofan IR结构 vs v8 ignition
